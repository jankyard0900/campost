<div class="container">
  <div class="row">
    <h4><%= @camp.name %>をレビュー</h4>
  </div>
  <%= form_with model: [@camp, @camp_review], url: camp_camp_reviews_path(@camp), method: :post do |f| %>
    <% if @camp_review.errors.any? %>
      <%= @camp_review.errors.count %>件のエラーが発生しました。
      <ul>
        <% @camp_review.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
      </ul>
    <% end %>
    <div>
      <p><b><%= @camp.name %></b></p>
    </div>
    <hr>
      <%= f.label :rate, "総合評価", class:'col-md-3 col-form-label' %>
    <div class="form-group row" id="star">
      <%= f.hidden_field :rate, id: :review_star, class: 'form-control' %>
    </div>
    <hr>
    <div>
      <p><b>キャンプ場の画像を追加する</b><br>※あれば写真を投稿してください(５枚まで）</p>
      <%= f.file_field :review_camp_images, multiple: true, accept: "image/*" %>
    </div>
    <hr>
    <div>
      <b><%= f.label :title, "レビュータイトル" %></b>
      <%= f.text_field :title, class: "form-control", placeholder: "伝えたいこと！" %>
    </div>
    <hr>
    <div>
      <b><%= f.label :review, "レビュー" %></b>
      <%= f.text_area :review, class: "form-control", placeholder: "「良かったこと」または「悪かったこと」" %>
    </div>
    <div>
      <%= f.submit "レビュー投稿", class: "btn btn-warning" %>
    </div>
  <% end %>
<img id="preview_0" style="width:15%;">
<img id="preview_1" style="width:15%;">
<img id="preview_2" style="width:15%;">
<img id="preview_3" style="width:15%;">
<img id="preview_4" style="width:15%;">


</div>
<script>
$(document).on('turbolinks:load', function() {
  $('#star').empty();
  $('#star').raty({
    size     : 36,
    starOff  : '<%= asset_path('star-off.png') %>',
    starOn   : '<%= asset_path('star-on.png') %>',
    starHalf: '<%=asset_path('star-half.png') %>',
    scoreName: 'camp_review[rate]',
    half: true,
  });
});
$('#camp_review_review_camp_images').on('change', function (e) {

    if(e.target.files.length > 5){

      alert('一度に投稿できるのは五枚までです。');
      // 五枚以上の画像を選択していた場合、選択したファイルをリセット。
      $('#camp_review_review_camp_images').val("");

      // 以前の画像のプレビューが残っていた場合は、
      // まだ画像選択できていると勘違いを誘発するため初期化。
      for( let i = 0; i < 5; i++) {
        $(`#preview_${i}`).attr('src', "");
      }

    }else{
      let reader = new Array(5);

      // 画像選択を二回した時、一回目より数が少なかったりすると画面上に残るので初期化
      for( let i = 0; i < 5; i++) {
        $(`#preview_${i}`).attr('src', "");
      }

      for(let i = 0; i < e.target.files.length; i++) {
        reader[i] = new FileReader();
        reader[i].onload = finisher(i,e);
        reader[i].readAsDataURL(e.target.files[i]);

        // onloadは別関数で準備しないとfor文内では使用できないので、関数を準備。
        function finisher(i,e){
          return function(e){
          $(`#preview_${i}`).attr('src', e.target.result);
          }
        }
      }
   }
});
</script>